# MXDRV 使用指南

MXDRV - 夏普 X68000 电脑音源驱动使用教程

文档编写 | Ripo_2006 | 2025/9/24

---

## 目录

- [简介](#简介)
- [文件头](#文件头)
- [乐器制作与定义](#乐器制作与定义)
  - [FM 乐器定义](#fm-乐器定义)
  - [ADPCM 乐器](#adpcm-乐器)
    - [PDX 文件制作](#pdx-文件制作)
    - [PDX 文件使用](#pdx-文件使用)
- [MXC 编译器](#mxc-编译器)
  - [MXC 编译教程](#mxc-编译教程)
  - [MXC MML 指令](#mxc-mml-指令)
- [NOTE 编译器](#note-编译器)
  - [NOTE 编译教程](#note-编译教程)
  - [命令行开关](#命令行开关)
  - [NOTE MML 指令](#note-mml-指令)

---

## 简介

MXDRV 是夏普 X68000 电脑的音源驱动程序，支持 OPM（FM 合成）和 OKIM6258（ADPCM）音源芯片。本文档详细介绍了如何使用 MXC 和 NOTE 两种编译器编写 MML（Music Macro Language）并生成 MDX 音乐文件。

---

## 文件头

### 设置曲名

```
#title "曲名"
```

### 指定 PCM 文件

```
#pcmfile "文件名.pdx"
```

设定一个 PDX 文件来播放 ADPCM。如需使用，请查看 [PDX 文件制作](#pdx-文件制作) 章节。

---

## 乐器制作与定义

### FM 乐器定义

#### 格式

```
@1~255={
AR, DR, SR, RR, SL, OL, KS, ML, DT1, DT2, AME,
AR, DR, SR, RR, SL, OL, KS, ML, DT1, DT2, AME,
AR, DR, SR, RR, SL, OL, KS, ML, DT1, DT2, AME,
AR, DR, SR, RR, SL, OL, KS, ML, DT1, DT2, AME,
CON, FL, OP
}
```

#### 参数说明

| 参数 | 名称 | 范围 | 说明 |
|------|------|------|------|
| AR | Attack Rate | 0~31 | 起音速率 |
| DR | Decay Rate | 0~31 | 衰减速率 |
| SR | Sustain Rate | 0~31 | 延音速率 |
| RR | Release Rate | 0~15 | 释音速率 |
| SL | Sustain Level | 0~15 | 延音电平 |
| OL | Operator Level | 0~127 | Operator 音量或调制等级 |
| KS | Key Scaling | 0~3 | ADSR 包络随音高缩放 |
| ML | Multiplier | 0~15 | Operator 音高倍数 |
| DT1 | Detune 1 | 0~7 | 弱失谐（0=不失谐，1~4=偏高，5~7=偏低）|
| DT2 | Detune 2 | 0~3 | 强失谐（数字越高越偏高音）|
| AME | Amplitude Modulation Enable | 0~1 | 调幅开关（0=关，1=开）|
| CON | Connection | 0~7 | FM 合成算法（Operator 连接方式）|
| FL | Feedback Level | 0~7 | 反馈等级（仅作用于 Operator 1）|
| OP | Operator Mask | - | 一般填 15（二进制 %1111，开启全部 4 个 Operator）|

**Operator Mask 对应关系：**
- 3 = 1 op
- 7 = 2 op
- 11 = 3 op
- 15 = 4 op

**参考资料：** [合成器基础：ADSR包络线 - 知乎](https://zhuanlan.zhihu.com/p/81771109)

---

### ADPCM 乐器

#### PDX 文件制作

PDX 文件是 MXDRV 中用于 PCM 通道的重要文件。以下是从零制作 PDX 文件的步骤：

##### 1. 转换 WAV 为 ADPCM

使用 WAV2ADP 将 `.wav` 文件转换为 raw ADPCM（`.pcm`）文件：

```bash
run68 wav2adp [filename.wav]
```

##### 2. 创建 PDL 文件

创建一个 `.txt` 文件并重命名为 `.pdl`，内容如下：

```
#ex-pdx 1

@0
1=文件名1.pcm
2=文件名2.pcm
3=文件名3.pcm
```

**说明：**
- `#ex-pdx` 启用扩展 PDX 格式，一个 bank 可载入约 90 个采样文件
- `@0` 定义 bank 编号
- 数字（1, 2, 3...）对应音符音高，映射到对应的 PCM 文件

##### 3. 生成 PDX 文件

在终端输入以下指令，或直接将 `.pdl` 文件拖入 MKPDX：

```bash
mkpdx filename.pdl
```

---

#### PDX 文件使用

PDX 文件只能在 PCM 通道（OKIM6258）播放。

##### 基础用法

使用音高音符指定采样：

```
o0 e4 e4 e4 e4
o0l4[e]4
```

##### 推荐用法

使用 `n#` 指令直接指定数值音高：

```
l8n1n2n3n2
n1,8n2,8n3,8n2,8
```

**示例：** 假设 1=kick.pcm，2=hat.pcm，3=clap.pcm

---

##### MXC 与 NOTE 编译器 PCM 通道对比

| 特性 | MXC 编译器 | NOTE 编译器 |
|------|-----------|-------------|
| PCM 通道数量 | 1 个 | 最多 8 个 |
| 音高调节 | 不支持 | 支持 |
| 音量调节 | 不支持 | 支持 |
| PCM 格式 | 仅 ADPCM | 支持 ADPCM 和 PCM |

**推荐：** 如对 PCM 通道有较高需求，建议使用 NOTE 编译器。

---

## MXC 编译器

### MXC 编译教程

在终端输入以下命令：

```bash
run68 mxc [你的mml文件.mml]
```

编译完成后，将在 MML 目录下生成对应的 MDX 文件。

---

### MXC MML 指令

#### 编写规则

- 所有指令严格区分大小写
- `#` 符号代表数值参数
- **Ticks** 是序列中使用的最小计算单位（本文档记为 `%`）
  - 十六分音符 = %12
  - 八分音符 = %24
  - 四分音符 = %48
  - 二分音符 = %96
  - 全音符 = %192

---

#### 通用指令

##### 通道标识符

| 指令 | 说明 |
|------|------|
| `A~H` | 设置 FM 通道标识符（OPM 拥有 8 个通道）|
| `P` | 设置 PCM 通道标识符（MXC 仅支持 1 个 PCM 通道）|

**注意：** 编写音符或效果前，必须先指定通道标识符。

---

##### 速度与节拍

| 指令 | 范围 | 说明 |
|------|------|------|
| `t#` | - | 设置 BPM（每分钟四分音符数量）|
| `@t#` | - | 直接设置 OPM register B 数值，默认 @t200 |

---

##### 乐器与音色

| 指令 | 范围 | 说明 |
|------|------|------|
| `@#` | 0~255 | 设置乐器编号（@0 为 PCM 通道专用）|
| `F#` | 0~4 | 设置 PCM 频率（默认 4=15.6kHz）|

**PCM 频率对应表：**
- 0 = 3.9kHz
- 1 = 5.2kHz
- 2 = 7.8kHz
- 3 = 10.4kHz
- 4 = 15.6kHz

---

##### 循环与八度

| 指令 | 说明 |
|------|------|
| `L` | 设置全局循环开始点 |
| `o#` | 设置八度音程（o0~o8，默认 o4）|
| `<` | 降低一个八度 |
| `>` | 升高一个八度 |
| `l#` | 设置音符默认时值（默认 l4）|

---

##### 音量控制

| 指令 | 范围 | 说明 |
|------|------|------|
| `v#` | 0~15 | 设置音量（默认 v8）|
| `@v#` | 0~127 | 高精度音量设置 |
| `(` | - | 降低一格音量 |
| `)` | - | 提高一格音量 |

---

##### 声像与失谐

| 指令 | 范围 | 说明 |
|------|------|------|
| `p#` | 0~3 | 设置声像（0=静音，1=左，2=右，3=立体声，默认 3）|
| `D#` | -32767~32767 | 设置失谐（以 1/64 半音为单位）|

---

##### 循环与注释

| 指令 | 范围 | 说明 |
|------|------|------|
| `[ ]#` | 2~255 | 循环 [ ] 内的指令 # 次 |
| `/` | - | 跳过循环（最后一次循环时跳过 `/` 后的指令）|
| `!` | - | 忽略 `!` 后的所有指令 |
| `;` | - | 行注释 |
| `/* */` | - | 块注释 |

---

#### 音符编写

##### 格式

```
nal
```

- `n` = 音符名称
- `a` = 升降号
- `l` = 时值

##### 音符与休止符

| 指令 | 说明 |
|------|------|
| `c d e f g a b` | 音符 |
| `r` | 休止符 |
| `+` | 升高半音 |
| `-` | 降低半音 |

##### 时值

| 指令 | 说明 |
|------|------|
| `1 2 4 8 12 16 24 32` | x 分音符 |
| `.` | 付点（延长时值的一半）|
| `%#` | 直接使用 Ticks 单位（例：c%48 = c4）|

##### 特殊音符指令

| 指令 | 范围 | 说明 |
|------|------|------|
| `n#` | 0~95 | 直接指定音高（n0=o0d+，n95=o8d）|
| `&` | - | 绑定 macro（连接前后音符）|
| `_` | - | 滑音（音符滑向另一音符）|

**示例：**
```
c4&c4        ; 等同于 c2
c4_f         ; 音符 c 以四分音符速度滑向 f
```

---

##### 音符属性

| 指令 | 范围 | 说明 |
|------|------|------|
| `q#` | 0~8 | 设置断音长度（默认 q8）|
| `@q#` | 0~% | 以 Ticks 为单位设置断音长度 |
| `k#` | 0~% | 延迟音符 # 个 Ticks |
| `w#` | 0~31 | 设置 OPM 噪声频率 |

---

##### 寄存器操作与同步

| 指令 | 说明 |
|------|------|
| `y#1,#2` | 向 OPM register #1 写入数值 #2 |
| `W` | 等待同步（停止播放直到收到同步指令）|
| `S#` | 发送同步（继续播放指定通道）|

---

#### LFO 相关指令

##### 音高 LFO

| 指令 | 参数 | 说明 |
|------|------|------|
| `MP#1,#2,#3` | #1=波形(0~2), #2=周期, #3=振幅 | 设置音高 LFO |
| `MPON` | - | 开启音高 LFO |
| `MPOF` | - | 关闭音高 LFO |

**波形类型：** 0=锯齿波，1=方波，2=三角波

---

##### 振幅 LFO

| 指令 | 参数 | 说明 |
|------|------|------|
| `MA#1,#2,#3` | #1=波形(0~2), #2=周期, #3=振幅 | 设置振幅 LFO |
| `MAON` | - | 开启振幅 LFO |
| `MAOF` | - | 关闭振幅 LFO |

---

##### LFO 延迟

| 指令 | 范围 | 说明 |
|------|------|------|
| `MD#` | 0~255 | 延迟 LFO 触发时间（Ticks）|

**注意：**
- MD=0 时，LFO 持续作用于通道
- MD>0 时，LFO 因音符重新触发
- 对 OPM LFO 指令无效

---

##### OPM LFO

| 指令 | 参数 | 说明 |
|------|------|------|
| `MH#1,#2,#3,#4,#5,#6,#7` | 详见下方 | 设置 OPM LFO |
| `MHON` | - | 开启 OPM LFO |
| `MHOF` | - | 关闭 OPM LFO |

**MH 参数说明：**
- #1 = LFO 波形（0=锯齿波，1=方波，2=三角波，3=噪波）
- #2 = LFRQ
- #3 = PMD
- #4 = AMD
- #5 = PMS
- #6 = AMS
- #7 = key sync（0=不同步，1=同步）

---

## NOTE 编译器

### NOTE 编译教程

在终端输入以下命令：

```bash
run68 NOTE [你的mml或mus文件.mml / mus]
```

编译完成后，将在 NOTE 目录下生成对应的 MDX 文件。

---

### 命令行开关

NOTE 提供丰富的命令行开关选项。使用方式：

```bash
run68 NOTE [文件名] -[开关]
```

#### 主要开关说明

| 开关 | 说明 |
|------|------|
| `-m<size>` | 指定输出 MDX 文件缓冲区大小（KB，默认 64）|
| `-x` | 反转八度命令 `<` `>` 方向（等同于 `#octave-rev`）|
| `-p` | 指定 ex-pcm 模式（等同于 `#ex-pcm`）|
| `-r` | 发生错误时删除 MDX 文件（等同于 `#remove`）|
| `-i<channel>` | 声道掩码，指定不进行转换的声道（A~H, P~W）|
| `-b` | 错误时发出提示音（仅真机有效，等同于 `#beep`）|
| `-l` | 输出 PCM 使用情况文件（`pcmuse.map`）|
| `-o` | 对旧版与新版 `pcmuse.map` 进行逻辑或运算（需配合 `-l`）|
| `-c [n]` | 压缩音长（默认仅压缩休止符，指定 n 则包含音符）|
| `-z [dvqpt012]` | 优化功能（删除或移动不必要的命令）|
| `-t [name]` | 保存音色数据为二进制文件（默认 `tone.bin`）|
| `-w [name]` | 保存波形数据为二进制文件（默认 `wave.bin`）|
| `-v [0\|1]` | 详细模式（识别转换进度及错误位置）|
| `-1` | 首次错误时中止转换 |
| `-e` | 忽略错误并输出文件 |

**合并写法：** 无参数开关可合并，如 `-xpr`

---

#### 优化参数详解（-z）

```bash
-z [dvqpt012]
```

| 参数 | 对应命令 |
|------|----------|
| `d` | D（失谐）|
| `v` | v, @v（音量）|
| `q` | q, @q（断音）|
| `p` | p（声像）|
| `t` | @（音色）|
| `0` | MD（LFO 延迟）|
| `1` | MP（音高 LFO）|
| `2` | MA（振幅 LFO）|

---

### NOTE MML 指令

#### 编写规则

- 所有指令严格区分大小写
- `#` 符号代表数值参数
- **Ticks** 是序列中使用的最小计算单位（本文档记为 `%`）
  - 十六分音符 = %12
  - 八分音符 = %24
  - 四分音符 = %48
  - 二分音符 = %96
  - 全音符 = %192

---

#### 全局指令

全局指令不区分大小写。

##### 文件与标题

| 指令 | 说明 |
|------|------|
| `#title "曲名"` | 设置 MDX 文件标题 |
| `#pcmfile "文件名.pdx"` | 设置指定的 PCM 文件 |
| `#include "文件名"` | 插入外部文件内容（最多嵌套 16 层）|
| `#play "<命令> [参数]"` | 设置转换完成后执行的命令 |

---

##### PCM 与音高

| 指令 | 说明 |
|------|------|
| `#ex-pcm` | 启用扩展 PCM 模式（激活 Q~W 通道）|
| `#tps <数值>` | 全局移调（-24~24 半音，默认不作用于 PCM）|
| `#tps-all` | 使 `#tps` 对所有声部生效 |
| `#detune <数值>` | D 命令偏移（-32768~32767）|

---

##### 八度与音程

| 指令 | 说明 |
|------|------|
| `#octave-rev` | 反转 `<` `>` 命令功能 |
| `#flat "音高"` | 指定音程始终附加降号（如 `#flat "c f"`）|
| `#sharp "音高"` | 指定音程始终附加升号 |
| `#natural "音高"` | 取消指定音程的 `#flat`/`#sharp` 设置 |
| `#normal "音高"` | 同 `#natural` |

---

##### 转换控制

| 指令 | 说明 |
|------|------|
| `#nlist` | 标记不进行转换的区域起点 |
| `#list` | 标记需要转换的区域起点 |
| `#overwrite` | 优先使用后续的同编号音色定义 |
| `#toneofs <数值>` | 为音色编号添加偏移量 |
| `#noreturn` | 取消 K 指令（残响切断）后的音色重新定义 |

---

##### 内存与错误处理

| 指令 | 说明 |
|------|------|
| `#wavemem` | 分配波形处理内存（约 128KB，可存储 128 个波形）|
| `#remove` | 转换错误时删除 MDX 文件 |
| `#beep` | 转换结束若有错误播放提示音（仅实机有效）|

---

##### 波形效果

| 指令 | 说明 |
|------|------|
| `#reste [0\|1]` | 设置波形效果是否作用于音符休止部分 |
| `#nreste [0\|1]` | 限制波形效果仅作用于音符实际发声部分 |
| `#coder` | 自动用休符补充通道标识符对应的缺失部分 |
| `#ncoder` | 不补充通道标识符对应的缺失部分 |
| `#glide [0\|1]` | 设置滑音效果的处理范围 |
| `#cont [0\|1\|2]` | 设置 `&` 连接符对波形相位的影响（默认 0）|
| `#wcmd [0\|1\|2]` | 设置波形效果生效时是否禁止写入相关通用命令（默认 0）|

---

##### 文件输入输出

| 指令 | 说明 |
|------|------|
| `#load-tone "文件名"` | 加载音色数据文件 |
| `#save-tone ["文件名"]` | 保存音色数据为二进制文件 |
| `#load-wave "文件名"` | 加载波形数据文件 |
| `#save-wave ["文件名"]` | 保存波形数据为二进制文件 |
| `#pcmlist [0\|1]` | 生成 PCM 文件使用情况报告（`pcmuse.map`）|

---

##### 优化与兼容

| 指令 | 说明 |
|------|------|
| `#compress [0\|1]` | 设置是否压缩音符音长 |
| `#opt ["dvqpt012*"]` | 设置 MDX 文件优化选项 |
| `#ver [0\|1]` | 设置是否启用 Barbados 兼容模式 |

---

#### 通用指令

##### 通道标识符

| 指令 | 说明 |
|------|------|
| `A~H` | 设置 FM 通道标识符（OPM 拥有 8 个通道）|
| `P~W` | 设置 PCM 通道标识符（OKIM6258 可分为 8 个通道）|

**注意：** 编写音符或效果前，必须先指定通道标识符。

---

##### 速度与节拍

| 指令 | 范围 | 说明 |
|------|------|------|
| `t#` | 19~4882 | 设置 BPM（每分钟四分音符数量）|
| `@t#` | 0~255 | 直接设置 OPM register B 数值 |

---

##### 乐器与音色

| 指令 | 范围 | 说明 |
|------|------|------|
| `@#` | 0~255 | 设置乐器（FM 和 PCM 通道可分别设置）|
| `@w#` | - | 设置波形 |
| `@k#` | - | 音色编号映射定义 |
| `@@#` | 0~255 | 音色宏定义 |
| `F#` | 0~4 | 设置 PCM 频率（默认 4=15.6kHz）|
| `F#` | 5~6 | 设置 PCM 频率（需 PCM8 v0.46+）|
| `F#` | 5~31 | 设置 PCM 频率（需 pcm8++ 驱动）|

**PCM 频率对应表（F0~F4）：**
- 0 = 3.9kHz
- 1 = 5.2kHz
- 2 = 7.8kHz
- 3 = 10.4kHz
- 4 = 15.6kHz

**扩展频率（F5~F6，需 PCM8 v0.46+）：**
- 5 = 16bit pcm / 15.6kHz
- 6 = 8bit pcm / 15.6kHz

---

##### 循环与八度

| 指令 | 说明 |
|------|------|
| `L` | 设置全局循环开始点 |
| `C` | 伪循环开始点（标记循环但不实际循环，不可与 L 同时使用）|
| `o#` | 设置八度音程（o0~o8，默认 o4）|
| `<` | 降低一个八度 |
| `>` | 升高一个八度 |
| `l#` | 设置音符默认时值（默认 l4）|

---

##### 音量控制

| 指令 | 范围 | 说明 |
|------|------|------|
| `v#` | 0~15 | 设置音量（默认 v8）|
| `@v#` | 0~127 | 高精度音量设置 |
| `V#` | - | 相对音量调整（叠加数值后写入 v/@v）|
| `VO#` | -127~127 | 音量命令偏移（默认 VO0）|
| `(#` | - | 降低 # 格音量（# 可省略，默认 1）|
| `)#` | - | 提高 # 格音量（# 可省略，默认 1）|
| `x#` | 0~15 | 设定紧随其后 1 个音符的音量 |
| `@x#` | 0~127 | 高精度设定紧随其后 1 个音符的音量 |

---

##### 声像与失谐

| 指令 | 范围 | 说明 |
|------|------|------|
| `p#` | 0~3 | 设置声像（0=静音，1=左，2=右，3=立体声，默认 3）|
| `D#` | -32767~32767 | 设置失谐（以 1/64 半音为单位）|
| `_D#` | -6144~6144 | 滑音失谐（用于音符后，线性改变音高）|
| `TR#` | -48~48 | 设置移调（对 PCM 通道同样有效，默认 TR0）|

---

##### 升降号控制

| 指令 | 说明 |
|------|------|
| `$FLAT {音符}` | 为指定音符始终添加降号 |
| `$SHARP {音符}` | 为指定音符始终添加升号 |
| `$NORMAL {音符}` | 解除降音/升音设置 |
| `$NATURAL {音符}` | 解除指定音符的 FLAT/SHARP 设置（省略 {音符} 时解除所有）|

---

##### 循环与注释

| 指令 | 范围 | 说明 |
|------|------|------|
| `[ ]#` | 2~255 | 循环 [ ] 内的指令 # 次 |
| `/` | - | 跳过循环（最后一次循环时跳过 `/` 后的指令）|
| `!` | - | 忽略 `!` 后的所有指令 |
| `;` | - | 行注释 |
| `/* */` | - | 块注释 |
| `?` | - | 范围跳过（忽略 `?` 包围范围内的实体命令输出）|

---

#### 音符编写

##### 格式

```
nal
```

- `n` = 音符名称
- `a` = 升降号
- `l` = 时值

##### 音符与休止符

| 指令 | 说明 |
|------|------|
| `c d e f g a b` | 音符 |
| `r` | 休止符 |
| `+` | 升高半音 |
| `-` | 降低半音 |

##### 时值

| 指令 | 说明 |
|------|------|
| `1 2 4 8 12 16 24 32` | x 分音符 |
| `.` | 付点（延长时值的一半）|
| `%#` 或 `#` | 直接使用 Ticks 单位（例：c%48 = c#48 = c4）|

##### 特殊音符指令

| 指令 | 范围 | 说明 |
|------|------|------|
| `n#` | 0~95 | 直接指定音高（n0=o0d+，n95=o8d）|
| `&` | - | 绑定 macro（连接前后音符，可写在行首）|
| `_` | - | 滑音（音符滑向另一音符）|
| `{ }` | - | 连音（按音符数量等分时值，最多 32 个音符/休符）|

**示例：**
```
c4&c4        ; 等同于 c2
c4&>c4       ; 跨八度绑定
c4_f         ; 音符 c 以四分音符速度滑向 f
{ceg}4       ; 三连音
```

---

##### 音符属性

| 指令 | 范围 | 说明 |
|------|------|------|
| `q#` | 0~8 | 设置断音长度（默认 q8）|
| `@q#` | 0~192 | 以 Ticks 为单位设置断音长度 |
| `Q#` | -256~256 | 波形专用量化（仅波形中有效）|
| `k#` | 0~255 | 延迟音符 # 个 Ticks |
| `w#` | 0~31 | 设置 OPM 噪声频率（不设置时默认关闭）|

**Q# 参数说明：**
- 0：恢复由 q/@q 控制
- 1~256：以全音长的 1/256 为单位量化
- -256~-1：绝对值为实际发音步数

---

##### 寄存器操作与同步

| 指令 | 说明 |
|------|------|
| `y#1,#2` | 向 OPM register #1 写入数值 #2 |
| `W` | 等待同步（停止播放直到收到同步指令）|
| `S#` | 发送同步（继续播放指定通道，A~H 或 P~W / 0~15）|

---

#### LFO 相关指令

NOTE 编译器的 LFO 指令与 MXC 编译器相同，请参考 [MXC LFO 相关指令](#lfo-相关指令)。

**注意：** NOTE 编译器不支持 OPM LFO 的 `MH`、`MHON`、`MHOF` 指令。

---

## 其他

本文档基于 MXDRV 手册整理编写。

---

## 参考资料

- [合成器基础：ADSR包络线 - 知乎](https://zhuanlan.zhihu.com/p/81771109)
- MXDRV 文档
- X68000 技术参考手册

---

**文档版本：** 0.6  
**最后更新：** 2025/9/24  
**编写者：** Ripo_2006
