# MXDRV 使用指南

MXDRV - 夏普 X68000 电脑音源驱动使用教程

文档编写 | Ripo_2006 | 2025/9/24

---

## 目录

- [简介](#简介)
- [文件头](#文件头)
- [乐器制作与定义](#乐器制作与定义)
  - [FM 乐器定义](#fm-乐器定义)
  - [ADPCM 乐器](#adpcm-乐器)
    - [PDX 文件制作](#pdx-文件制作)
    - [PDX 文件使用](#pdx-文件使用)
- [MXC 编译器](#mxc-编译器)
  - [MXC 编译教程](#mxc-编译教程)
  - [MXC MML 指令](#mxc-mml-指令)
- [NOTE 编译器](#note-编译器)
  - [NOTE 编译教程](#note-编译教程)
  - [命令行开关](#命令行开关)
  - [NOTE MML 指令](#note-mml-指令)

---

## 简介

MXDRV 是夏普 X68000 电脑的音源驱动程序，支持 OPM（FM 合成）和 OKIM6258（ADPCM）音源芯片。本文档详细介绍了如何使用 MXC 和 NOTE 两种编译器编写 MML（Music Macro Language）并生成 MDX 音乐文件。

---

## 文件头

### 设置曲名

```
#title "曲名"
```

### 指定 PCM 文件

```
#pcmfile "文件名.pdx"
```

设定一个 PDX 文件来播放 ADPCM。如需使用，请查看 [PDX 文件制作](#pdx-文件制作) 章节。

---

## 乐器制作与定义

### FM 乐器定义

#### 格式

```
@1~255={
AR, DR, SR, RR, SL, OL, KS, ML, DT1, DT2, AME,
AR, DR, SR, RR, SL, OL, KS, ML, DT1, DT2, AME,
AR, DR, SR, RR, SL, OL, KS, ML, DT1, DT2, AME,
AR, DR, SR, RR, SL, OL, KS, ML, DT1, DT2, AME,
CON, FL, OP
}
```

#### 参数说明

| 参数 | 名称 | 范围 | 说明 |
|------|------|------|------|
| AR | Attack Rate | 0~31 | 起音速率 |
| DR | Decay Rate | 0~31 | 衰减速率 |
| SR | Sustain Rate | 0~31 | 延音速率 |
| RR | Release Rate | 0~15 | 释音速率 |
| SL | Sustain Level | 0~15 | 延音电平 |
| OL | Operator Level | 0~127 | Operator 音量或调制等级 |
| KS | Key Scaling | 0~3 | ADSR 包络随音高缩放 |
| ML | Multiplier | 0~15 | Operator 音高倍数 |
| DT1 | Detune 1 | 0~7 | 弱失谐（0=不失谐，1~4=偏高，5~7=偏低）|
| DT2 | Detune 2 | 0~3 | 强失谐（数字越高越偏高音）|
| AME | Amplitude Modulation Enable | 0~1 | 调幅开关（0=关，1=开）|
| CON | Connection | 0~7 | FM 合成算法（Operator 连接方式）|
| FL | Feedback Level | 0~7 | 反馈等级（仅作用于 Operator 1）|
| OP | Operator Mask | - | 一般填 15（二进制 %1111，开启全部 4 个 Operator）|

**Operator Mask 对应关系：**
- 3 = 1 op
- 7 = 2 op
- 11 = 3 op
- 15 = 4 op

**参考资料：** [合成器基础：ADSR包络线 - 知乎](https://zhuanlan.zhihu.com/p/81771109)

---

### ADPCM 乐器

#### PDX 文件制作

PDX 文件是 MXDRV 中用于 PCM 通道的重要文件。以下是从零制作 PDX 文件的步骤：

##### 1. 转换 WAV 为 ADPCM

使用 WAV2ADP 将 `.wav` 文件转换为 raw ADPCM（`.pcm`）文件：

```bash
run68 wav2adp [filename.wav]
```

##### 2. 创建 PDL 文件

创建一个 `.txt` 文件并重命名为 `.pdl`，内容如下：

```
#ex-pdx 1

@0
1=文件名1.pcm
2=文件名2.pcm
3=文件名3.pcm
```

**说明：**
- `#ex-pdx` 启用扩展 PDX 格式，一个 bank 可载入约 90 个采样文件
- `@0` 定义 bank 编号
- 数字（1, 2, 3...）对应音符音高，映射到对应的 PCM 文件

##### 3. 生成 PDX 文件

在终端输入以下指令，或直接将 `.pdl` 文件拖入 MKPDX：

```bash
mkpdx filename.pdl
```

---

#### PDX 文件使用

PDX 文件只能在 PCM 通道（OKIM6258）播放。

##### 基础用法

使用音高音符指定采样：

```
o0 e4 e4 e4 e4
o0l4[e]4
```

##### 推荐用法

使用 `n#` 指令直接指定数值音高：

```
l8n1n2n3n2
n1,8n2,8n3,8n2,8
```

**示例：** 假设 1=kick.pcm，2=hat.pcm，3=clap.pcm

---

##### MXC 与 NOTE 编译器 PCM 通道对比

| 特性 | MXC 编译器 | NOTE 编译器 |
|------|-----------|-------------|
| PCM 通道数量 | 1 个 | 最多 8 个 |
| 音高调节 | 不支持 | 支持 |
| 音量调节 | 不支持 | 支持 |
| PCM 格式 | 仅 ADPCM | 支持 ADPCM 和 PCM |

**推荐：** 如对 PCM 通道有较高需求，建议使用 NOTE 编译器。

---

## MXC 编译器

### MXC 编译教程

在终端输入以下命令：

```bash
run68 mxc [你的mml文件.mml]
```

编译完成后，将在 MML 目录下生成对应的 MDX 文件。

---

### MXC MML 指令

#### 编写规则

- 所有指令严格区分大小写
- `#` 符号代表数值参数
- **Ticks** 是序列中使用的最小计算单位（本文档记为 `%`）
  - 十六分音符 = %12
  - 八分音符 = %24
  - 四分音符 = %48
  - 二分音符 = %96
  - 全音符 = %192

---

#### 通用指令

##### 通道标识符

| 指令 | 说明 |
|------|------|
| `A~H` | 设置 FM 通道标识符（OPM 拥有 8 个通道）|
| `P` | 设置 PCM 通道标识符（MXC 仅支持 1 个 PCM 通道）|

**注意：** 编写音符或效果前，必须先指定通道标识符。

---

##### 速度与节拍

| 指令 | 范围 | 说明 |
|------|------|------|
| `t#` | - | 设置 BPM（每分钟四分音符数量）|
| `@t#` | - | 直接设置 OPM register B 数值，默认 @t200 |

---

##### 乐器与音色

| 指令 | 范围 | 说明 |
|------|------|------|
| `@#` | 0~255 | 设置乐器编号（@0 为 PCM 通道专用）|
| `F#` | 0~4 | 设置 PCM 频率（默认 4=15.6kHz）|

**PCM 频率对应表：**
- 0 = 3.9kHz
- 1 = 5.2kHz
- 2 = 7.8kHz
- 3 = 10.4kHz
- 4 = 15.6kHz

---

##### 循环与八度

| 指令 | 说明 |
|------|------|
| `L` | 设置全局循环开始点 |
| `o#` | 设置八度音程（o0~o8，默认 o4）|
| `<` | 降低一个八度 |
| `>` | 升高一个八度 |
| `l#` | 设置音符默认时值（默认 l4）|

---

##### 音量控制

| 指令 | 范围 | 说明 |
|------|------|------|
| `v#` | 0~15 | 设置音量（默认 v8）|
| `@v#` | 0~127 | 高精度音量设置 |
| `(` | - | 降低一格音量 |
| `)` | - | 提高一格音量 |

---

##### 声像与失谐

| 指令 | 范围 | 说明 |
|------|------|------|
| `p#` | 0~3 | 设置声像（0=静音，1=左，2=右，3=立体声，默认 3）|
| `D#` | -32767~32767 | 设置失谐（以 1/64 半音为单位）|

---

##### 循环与注释

| 指令 | 范围 | 说明 |
|------|------|------|
| `[ ]#` | 2~255 | 循环 [ ] 内的指令 # 次 |
| `/` | - | 跳过循环（最后一次循环时跳过 `/` 后的指令）|
| `!` | - | 忽略 `!` 后的所有指令 |
| `;` | - | 行注释 |
| `/* */` | - | 块注释 |

---

#### 音符编写

##### 格式

```
nal
```

- `n` = 音符名称
- `a` = 升降号
- `l` = 时值

##### 音符与休止符

| 指令 | 说明 |
|------|------|
| `c d e f g a b` | 音符 |
| `r` | 休止符 |
| `+` | 升高半音 |
| `-` | 降低半音 |

##### 时值

| 指令 | 说明 |
|------|------|
| `1 2 4 8 12 16 24 32` | x 分音符 |
| `.` | 付点（延长时值的一半）|
| `%#` | 直接使用 Ticks 单位（例：c%48 = c4）|

##### 特殊音符指令

| 指令 | 范围 | 说明 |
|------|------|------|
| `n#` | 0~95 | 直接指定音高（n0=o0d+，n95=o8d）|
| `&` | - | 绑定 macro（连接前后音符）|
| `_` | - | 滑音（音符滑向另一音符）|

**示例：**
```
c4&c4        ; 等同于 c2
c4_f         ; 音符 c 以四分音符速度滑向 f
```

---

##### 音符属性

| 指令 | 范围 | 说明 |
|------|------|------|
| `q#` | 0~8 | 设置断音长度（默认 q8）|
| `@q#` | 0~% | 以 Ticks 为单位设置断音长度 |
| `k#` | 0~% | 延迟音符 # 个 Ticks |
| `w#` | 0~31 | 设置 OPM 噪声频率 |

---

##### 寄存器操作与同步

| 指令 | 说明 |
|------|------|
| `y#1,#2` | 向 OPM register #1 写入数值 #2 |
| `W` | 等待同步（停止播放直到收到同步指令）|
| `S#` | 发送同步（继续播放指定通道）|

---

#### LFO 相关指令

##### 音高 LFO

| 指令 | 参数 | 说明 |
|------|------|------|
| `MP#1,#2,#3` | #1=波形(0~2), #2=周期, #3=振幅 | 设置音高 LFO |
| `MPON` | - | 开启音高 LFO |
| `MPOF` | - | 关闭音高 LFO |

**波形类型：** 0=锯齿波，1=方波，2=三角波

---

##### 振幅 LFO

| 指令 | 参数 | 说明 |
|------|------|------|
| `MA#1,#2,#3` | #1=波形(0~2), #2=周期, #3=振幅 | 设置振幅 LFO |
| `MAON` | - | 开启振幅 LFO |
| `MAOF` | - | 关闭振幅 LFO |

---

##### LFO 延迟

| 指令 | 范围 | 说明 |
|------|------|------|
| `MD#` | 0~255 | 延迟 LFO 触发时间（Ticks）|

**注意：**
- MD=0 时，LFO 持续作用于通道
- MD>0 时，LFO 因音符重新触发
- 对 OPM LFO 指令无效

---

##### OPM LFO

| 指令 | 参数 | 说明 |
|------|------|------|
| `MH#1,#2,#3,#4,#5,#6,#7` | 详见下方 | 设置 OPM LFO |
| `MHON` | - | 开启 OPM LFO |
| `MHOF` | - | 关闭 OPM LFO |

**MH 参数说明：**
- #1 = LFO 波形（0=锯齿波，1=方波，2=三角波，3=噪波）
- #2 = LFRQ
- #3 = PMD
- #4 = AMD
- #5 = PMS
- #6 = AMS
- #7 = key sync（0=不同步，1=同步）

---

## NOTE 编译器

NOTE（DIS，1994/95）是面向 mxdrv2 v0.8.5 的 MML → MDX 转换器。

### NOTE 编译教程

在终端输入以下命令：

```bash
run68 NOTE [switch] <mml file[.mml|.mus]>
```

- 读取文件名省略扩展名时，优先 `.mml`，其次 `.mus`。
- 无参数开关可合并，如 `-xpr`。
- 编译完成后，将在 NOTE 目录下生成对应的 MDX 文件。

---

### 命令行开关

NOTE 提供丰富的命令行开关选项。使用方式：

```bash
run68 NOTE [switch] <mml file[.mml|.mus]>
```

#### 主要开关说明

| 开关 | 说明 |
|------|------|
| `-m<size>` | 指定输出 MDX 文件缓冲区大小（KB，默认 64）|
| `-x` | 反转八度命令 `<` `>` 方向（等同于 `#octave-rev`）|
| `-p` | 指定 ex-pcm 模式（等同于 `#ex-pcm`）|
| `-r` | 发生错误时删除 MDX 文件（等同于 `#remove`）|
| `-i<channel>` | 通道掩码，指定不进行转换的通道（A~H, P~W，大小写均可）|
| `-b` | 错误时发出提示音（仅真机有效，等同于 `#beep`）|
| `-l` | 输出 PCM 使用情况文件（`pcmuse.map`）|
| `-o` | 对旧版与新版 `pcmuse.map` 进行逻辑或运算（需配合 `-l`）|
| `-c[n]` | 压缩音长（默认仅压缩休止符，`-cn` 时包含音符；详见下文）|
| `-z[dvqpt012]` | 最适化（对 D / v/@v / q/@q / p / @ / MD / MP / MA 删除与移动冗余命令）|
| `-t[name]` | 保存音色数据（二进制，省略文件名则输出 `tone.bin`）|
| `-w[name]` | 保存波形数据（二进制，省略文件名则输出 `wave.bin`）|
| `-v[0/1]` | verbose：0=错误后续变色高亮；1=在错误位置前显示 `→` |
| `-1` | 首次错误时中止转换 |
| `-e` | 忽略错误也输出文件（即使发生转换错误，也会执行 `-t/-w/-l` 的文件输出）|

**合并写法：** 无参数开关可合并，如 `-xpr`

---

#### -c 音长压缩说明

- `-c`：仅压缩可连接的休止符音长。
- `-cn`：在 `-c` 的基础上，音符也作为压缩对象（可能改变量化效果，请注意）。
- 以下情况不会进行压缩：连符 `{}` 中、波形效果处理中、带 `_`（ポルタメント）的音符、GL グライド加工中等。
- 压缩受条件限制，部分情况下可能无法按预期生效。

#### 优化参数详解（-z）

```bash
-z[dvqpt012]
```

- 不带参数时，默认对 `D v @v q @q p @ MD MP MA` 等命令进行删除/移动以最适化。
- 可通过组合参数选择需要最适化的命令组（对应关系见下表）。

| 参数 | 对应命令 |
|------|----------|
| `d` | D（失谐）|
| `v` | v, @v（音量）|
| `q` | q, @q（断音）|
| `p` | p（声像）|
| `t` | @（音色）|
| `0` | MD（LFO 延迟）|
| `1` | MP（音高 LFO）|
| `2` | MA（振幅 LFO）|

---

### NOTE MML 指令

#### 编写规则

- MML 中部分命令区分大小写（例如 `v` 与 `V` 行为不同；伪指令 `#...` 不区分大小写）
- `#` 符号代表数值参数
- **Ticks** 是序列中使用的最小计算单位（本文档记为 `%`）
  - 十六分音符 = %12
  - 八分音符 = %24
  - 四分音符 = %48
  - 二分音符 = %96
  - 全音符 = %192

---

#### 识别符

`note.doc` 中约定：各行行首（除特殊情况外）的第 1 个字符作为该行的识别符，类型如下：

| 识别符 | 说明 |
|------|------|
| `A~H` | OPM（FM）通道的 MML 行 |
| `P~W` | PCM 通道的 MML 行 |
| `#字符串` | 伪指令（字符串内容不同，行为不同） |
| `@数字` | 音色定义 |
| `@w数字` | 波形定义 |
| `@k数字` | 音色编号映射定义 |
| `@@数字` | 音色宏定义 |
| `宏名` | 宏定义 |

**多通道简写：**
- 仅在 MML 行（通道识别符）中，若连续写多个通道识别符，则视为这些通道共享同一段 MML：`ABC c4 d4 e4` 会同时写入 A/B/C 三个通道。
- 同一识别符重复书写等同于一次：`AAA ceg` 等同于 `A ceg`。

---

#### 全局指令

全局指令不区分大小写。

##### 文件与标题

| 指令 | 说明 |
|------|------|
| `#title "曲名"` | 设置 MDX 文件标题 |
| `#pcmfile "文件名.pdx"` | 设置指定的 PCM 文件 |
| `#include "文件名"` | 插入外部文件内容（最多嵌套 16 层）|
| `#play "<命令> [参数]"` | 设置转换完成后执行的命令 |

**#play 补充：**
- 转换结束后执行；若发生转换错误或按下 Shift 键，则不会执行。
- 命令按 PATH 搜索；写成全路径可减少搜索时间、缩短启动耗时。

##### 字符串参数规则

- 伪指令的字符串参数默认以半角空格/Tab 分隔，仅取第 1 段作为参数，后续内容会被忽略。
- 如需在参数中包含空格/Tab，请使用 `'` 或 `"` 引号包裹。
- 引号未闭合时，引号范围会延伸到行末。

示例：
```
#title 1st. item       ; 标题=1st.
#title "1st. item"     ; 标题=1st. item
#title "It's"          ; 标题=It's
#title It"'"s          ; 标题=It's
#title '"start"'       ; 标题="start"
```

---

##### PCM 与音高

| 指令 | 说明 |
|------|------|
| `#ex-pcm` | 启用扩展 PCM 模式（激活 Q~W 通道）|
| `#tps <数值>` | 全局移调（-24~24 半音，默认不作用于 PCM）|
| `#tps-all` | 使 `#tps` 对所有声部生效 |
| `#detune <数值>` | D 命令偏移（-32768~32767）|

---

##### 八度与音程

| 指令 | 说明 |
|------|------|
| `#octave-rev` | 反转 `<` `>` 命令功能 |
| `#flat "音高"` | 指定音程始终附加降号（如 `#flat "c f"`）|
| `#sharp "音高"` | 指定音程始终附加升号 |
| `#natural "音高"` | 取消指定音程的 `#flat`/`#sharp` 设置 |
| `#normal "音高"` | 同 `#natural` |

---

##### 转换控制

| 指令 | 说明 |
|------|------|
| `#nlist` | 标记不进行转换的区域起点 |
| `#list` | 标记需要转换的区域起点 |
| `#overwrite` | 优先使用后续的同编号音色定义 |
| `#toneofs <数值>` | 为音色编号添加偏移量 |
| `#noreturn` | 取消 K 指令（残响切断）后的音色重新定义 |

**说明：** `#nlist` ～ `#list` 包围的范围不会被转换输出。

---

##### 内存与错误处理

| 指令 | 说明 |
|------|------|
| `#wavemem` | 分配波形处理内存（约 128KB，可存储 128 个波形）|
| `#remove` | 转换错误时删除 MDX 文件 |
| `#beep` | 转换结束若有错误播放提示音（仅实机有效）|

---

##### 波形效果

| 指令 | 说明 |
|------|------|
| `#reste [0/1]` | 设置波形效果是否作用于音符休止部分 |
| `#nreste [0/1]` | 限制波形效果仅作用于音符实际发声部分 |
| `#coder` | 自动用休符补充通道标识符对应的缺失部分 |
| `#ncoder` | 不补充通道标识符对应的缺失部分 |
| `#glide [0/1]` | 设置滑音效果的处理范围 |
| `#cont [0/1/2]` | 设置 `&` 连接符对波形相位的影响（默认 0）|
| `#wcmd [0/1/2]` | 设置波形效果生效时是否禁止写入相关通用命令（默认 0）|

**补充说明（note.doc）：**
- `#reste [0/1]`
  - 无参数或 `0`：对“量化后形成的休止部分”也施加波形效果。
  - `1`：休止符本身也施加波形效果。
  - 同步模式下若希望休止符期间波形相位持续推进，可用 `&` 连接或设置 `#cont 2`。
- `#nreste [0/1]`
  - 无参数或 `0`：波形效果仅作用于音符的实音长部分，不会在实音长结束时回退状态。
  - 非 `0`：实音长结束时，将波形效果造成的状态回退到效果前。
- `#coder / #ncoder`：用于和弦输入（`「」`/`` ` ` ``）等“音符数不足通道数”的情况，决定是否自动用休止补齐。
- `#glide [0/1]`：控制 GL グライド对 `&` 连接音符的处理；`0` 连 `&` 后的音符也加工，非 `0` 时仅加工第 1 个音符。
- `#cont [0/1/2]`
  - 无参数或 `0`：波形效果把 `&` 连接的音符/休止视为同一个音符处理（相位连续）。
  - `1`：忽略 `&`，在连接点也进行相位初始化/更新。
  - `2`：在 `1` 的基础上，同步模式下遇到休止不会进行相位初始化。
- `#wcmd [0/1/2]`：控制 AP/DT/VM 波形效果期间相关通用命令（`p/D/v/@v/( )/V`）的写入抑制：`0` 正常写入；`1` 不写入但仍记忆其值并影响波形效果；`2` 完全忽略相关命令。

---

##### 文件输入输出

| 指令 | 说明 |
|------|------|
| `#load-tone "文件名"` | 加载音色数据文件 |
| `#save-tone ["文件名"]` | 保存音色数据为二进制文件 |
| `#load-wave "文件名"` | 加载波形数据文件 |
| `#save-wave ["文件名"]` | 保存波形数据为二进制文件 |
| `#pcmlist [0/1]` | 生成 PCM 文件使用情况报告（`pcmuse.map`）|

**补充说明（note.doc）：**
- `#load-tone` / `#load-wave`：用于读取 `-t` / `-w` 生成的二进制数据与注册状态；会按加载内容初始化当前状态，即使此前已写过音色/波形定义也会被覆盖。
- `#save-tone` / `#save-wave`：与命令行 `-t` / `-w` 等价，但若命令行也指定了对应开关，则以命令行设置优先。
- `#load-wave` 会按通道分别加载（考虑到波形可重定义的特性）。
- `#pcmlist`：与命令行 `-l` / `-o` 等价：无参数或 `0`=仅输出 `pcmuse.map`；`1`=与旧 `pcmuse.map` 做逻辑或后输出。

---

##### 优化与兼容

| 指令 | 说明 |
|------|------|
| `#compress [0/1]` | 设置是否压缩音符音长 |
| `#opt ["dvqpt012*"]` | 设置 MDX 文件优化选项 |
| `#ver [0/1]` | 设置是否启用 verbose 模式（同 `-v`） |

**补充说明（note.doc）：**
- `#compress [0/1]`：与命令行 `-c` / `-cn` 等价；无参数或 `0`=仅休止符，`1`=包含音符；有效范围从该行开始，且命令行设置优先；初始默认不压缩。
- `#opt ["dvqpt012*"]`：与命令行 `-z` 等价；省略参数表示停止最适化；参数 `*` 等同 `dvqpt012`。
- `#ver [0/1]`：与命令行 `-v` 等价；有效范围从该行开始，且命令行设置优先；初始默认关闭。与命令行 `-v` 不同的是：不会显示当前正在处理的通道。

##### 默认设置（note.doc）

```
#tps 0
#detune 0
#natural "cdefgab"   ; 不指定 sharp/flat
#list                ; 默认文本区域
#nreste 0            ; 波形效果仅作用实音长部分
#ncoder              ; 代码输入不足不补休止
#glide 0             ; '&' 后音符也进行 GL 加工
#cont 0              ; '&' 连接时相位连续
#wcmd 0              ; 波形效果中仍写入相关通用命令
#toneofs 0
```

##### 可重复设置的伪指令（note.doc）

```
#title #pcmfile #include #tps
#detune #flat #sharp #natural(#normal)
#octave-rev #play #nlist #list
#reste #nreste #coder #ncoder
#glide #load-tone #load-wave #cont
#wcmd #pcmlist #compress #save-tone
#save-wave #opt #ver #toneofs
```

---

#### 通用指令

##### 通道标识符

| 指令 | 说明 |
|------|------|
| `A~H` | 设置 FM 通道标识符（OPM 拥有 8 个通道）|
| `P~W` | 设置 PCM 通道标识符（OKIM6258 可分为 8 个通道）|

**注意：** 编写音符或效果前，必须先指定通道标识符。

---

##### 速度与节拍

| 指令 | 范围 | 说明 |
|------|------|------|
| `t#` | 19~4882 | 设置 BPM（每分钟四分音符数量）|
| `@t#` | 0~255 | 直接设置 OPM register B 数值 |

---

##### 乐器与音色

| 指令 | 范围 | 说明 |
|------|------|------|
| `@#` | 0~255 | 设置乐器（FM 和 PCM 通道可分别设置）|
| `@w#` | - | 设置波形 |
| `@k#` | - | 音色编号映射定义 |
| `@@#` | 0~255 | 音色宏定义 |
| `SMON` | - | 启用音色宏（默认启用） |
| `SMOF` | - | 禁用音色宏 |
| `KS#` | 0~7 | 按音程自动切换音色（使用 `@k#` 映射；此模式下不展开音色宏，且会强制优化 `@`） |
| `KSON` | - | 恢复音色自动切换 |
| `KSOF` | - | 停止音色自动切换 |
| `F#` | 0~4 | 设置 PCM 频率（默认 4=15.6kHz）|
| `F#` | 5~6 | 设置 PCM 频率（需 PCM8 v0.46+）|
| `F#` | 5~31 | 设置 PCM 频率（需 pcm8++ 驱动）|

**PCM 频率对应表（F0~F4）：**
- 0 = 3.9kHz
- 1 = 5.2kHz
- 2 = 7.8kHz
- 3 = 10.4kHz
- 4 = 15.6kHz

**扩展频率（F5~F6，需 PCM8 v0.46+）：**
- 5 = 16bit pcm / 15.6kHz
- 6 = 8bit pcm / 15.6kHz

**补充（note.doc）：**
- PCM 通道中 `@#` 表示 bank 号（初始 `@0`）；FM 通道中 `@#` 初始值不定。

##### @w 波形定义（Wave Memory）

```
@w<波形号> = {type, loop, data0, data1, ...}
```

- 波形号范围：0~127；定义位置之后生效。
- `type`：0=无循环，1=有循环。
- `loop`：循环点（仅 `type=1` 时有效），以 `data0` 为基准。
- `data`：波形数据，最多 512 个；范围 -32768~32767；可用 `$` 16 进制。

##### @k 音色编号映射定义（Key-map）

```
@k<map> = {v1, v2, ..., v96}
```

- `map` 范围：0~7；定义位置之后生效。
- `v1~v96` 对应音程 `o0d+` ～ `o8d`（共 96 个），取值范围 0~255（音色号）。

##### @@ 音色宏定义（Tone Macro）

```
@@<音色号> = "内容"
```

- 当该音色被使用后，宏内容会立刻展开。
- 默认启用音色宏（`SMON`），可用 `SMOF` 禁用。

---

##### 循环与八度

| 指令 | 说明 |
|------|------|
| `L` | 设置全局循环开始点 |
| `C` | 伪循环开始点（标记循环但不实际循环，不可与 L 同时使用）|
| `o#` | 设置八度音程（o0~o8，默认 o4）|
| `<` | 降低一个八度 |
| `>` | 升高一个八度 |
| `l#` | 设置音符默认时值（默认 l4）|

---

##### 音量控制

| 指令 | 范围 | 说明 |
|------|------|------|
| `v#` | 0~15 | 设置音量（默认 v8）|
| `@v#` | 0~127 | 高精度音量设置 |
| `V#` | - | 相对音量调整（叠加数值后写入 v/@v）|
| `VO#` | -127~127 | 音量命令偏移（默认 VO0）|
| `(#` | - | 降低 # 格音量（# 可省略，默认 1）|
| `)#` | - | 提高 # 格音量（# 可省略，默认 1）|
| `x#` | 0~15 | 设定紧随其后 1 个音符的音量 |
| `@x#` | 0~127 | 高精度设定紧随其后 1 个音符的音量 |

**补充（note.doc）：**
- `(数值` / `)数值` 的数值可省略。
- `V<数值>` 为“写回型”的相对音量：以当时的音量为基准计算并写回 `v` 或 `@v`，不会把 `( )` 已造成的变化纳入计算；音量会自动裁剪，不会因超范围报错。

示例（note.doc）：
```
v4 [a)]8       ; v4 a v5 a v6 a ... v12 a
v4 [a V1]8     ; 相对计算后写回 v/@v（( ) 的变化不参与）
```

---

##### 声像与失谐

| 指令 | 范围 | 说明 |
|------|------|------|
| `p#` | 0~3 | 设置声像（0=Cut，1=左，2=右，3=左右/中，默认 p3）|
| `D#` | -32767~32767 | 设置失谐（以 1/64 半音为单位）|
| `_D#` | -6144~6144 | 滑音失谐（用于音符后，线性改变音高）|
| `TR#` | -48~48 | 设置移调（对 PCM 通道同样有效，默认 TR0）|

---

##### 升降号控制

| 指令 | 说明 |
|------|------|
| `$FLAT {音符}` | 为指定音符始终添加降号 |
| `$SHARP {音符}` | 为指定音符始终添加升号 |
| `$NORMAL {音符}` | 解除降音/升音设置 |
| `$NATURAL {音符}` | 解除指定音符的 FLAT/SHARP 设置（省略 {音符} 时解除所有）|

**补充（note.doc）：**
- `$...` 仅在当前通道内有效；`#flat/#sharp/#natural` 对所有通道有效。
- `$...` 与 `#...` 同时使用时优先级相同，以后指定者为准。
- PCM 通道使用普通音程表记时也会受此修正影响。
- 与移调（`#tps`/`TR`）同时使用时：先执行升降号修正，再执行移调。

---

##### 循环与注释

| 指令 | 范围 | 说明 |
|------|------|------|
| `[ ]#` | 2~255 | 循环 [ ] 内的指令 # 次 |
| `/` | - | 跳过循环（最后一次循环时跳过 `/` 后的指令）|
| `!` | - | 忽略 `!` 后的所有指令 |
| `;` | - | 行注释 |
| `//` | - | 行注释（忽略到行尾）|
| `*` | - | 行注释（忽略到行尾）|
| `/* */` | - | 块注释 |
| `?` | - | 范围跳过（忽略 `?` 包围范围内的实体命令输出）|

**`?` 范围跳过补充（note.doc）：**
- `?` 包围范围内，具有“实体输出”的命令不会写入数据；无实体命令（如 `o < > l` 等）会保持状态。
- 因实体命令的状态不会传到音源驱动侧，范围结束后通常需要重新设置相关参数。
- 该范围内语法检查会更宽松；但 `L`、`C` 等仍会被原样转换输出，请注意选择使用位置。

---

##### GL グライド（音头滑音）

| 指令 | 参数/范围 | 说明 |
|------|----------|------|
| `GL<值>,<步>` | 值=-6144~6144；步=1~255 | 对音符开头进行滑音加工（单位：半音 1/64）。`GL` 本身也相当于 `GLON` |
| `GLOF` | - | 停止 GL 加工 |
| `GLON` | - | 恢复 GL 加工 |

**补充（note.doc）：**
- `GL` 不作用于 PCM 通道、连符 `{}` 中、带ポルタメント（`_`）的音符，以及音程号表记 `n<数字>` 的音符。
- GL 加工中波形效果会被中断。
- 音符音长小于 GL 指定步数时，不进行加工。

示例（note.doc）：
```
A GL-32,6 c4
; 变换后大致等价于：
A D-32 c%6_D32 & D0 c%42
```

##### 波形内存效果指令（AP/DT/VM/KM/TL/YA）

波形内存效果会将音符拆分并插入命令，因此波形数据 1 要素的步数越小，生成的 MDX 往往越大。

**前置条件：**
- 需要先使用 `#wavemem` 申请波形内存。
- 需要先定义 `@w#` 波形数据。

**通用参数（%1,%2,%3）：**
- `%1`：波形号
- `%2`：1 要素的步数 / 音符数
- `%3`：同步模式：0=非同步1，1=同步，2=非同步2

**同步模式补充（note.doc）：**
- 非同步2（%3=2）下休止符默认不会推进相位，但在 `#reste 1` 时休止也会按音符处理并推进相位。
- 同步模式（%3=1）下 `&`、`#cont` 等会影响相位是否在连接点被初始化（见 `#cont` 说明）。

###### AP（Auto Pan）

| 指令 | 说明 |
|------|------|
| `AP%1,%2,%3` | 自动声像（波形内存） |
| `APD<步>` | 延迟（-255~32767，默认 0；负值规则见下文） |
| `APL<步>` | 修改 1 要素步数/音符数（保持状态；当前计数结束后生效） |
| `APON` | 再开（恢复） |
| `APOF` | 停止 |

**注意：** PCM 通道中音符途中改变声像无效。

###### DT（Detune）

| 指令 | 说明 |
|------|------|
| `DT%1,%2,%3` | 失谐（波形内存；波形数据会加到当前 `D` 值上） |
| `DTD<步>` | 延迟（-255~32767，默认 0；负值规则见下文） |
| `DTS<值>` | 失谐倍率（0 等同 1；值过大可能溢出；默认 0） |
| `DTL<步>` | 修改 1 要素步数/音符数（保持状态；当前计数结束后生效） |
| `DTON` | 再开（恢复） |
| `DTOF` | 停止 |

###### TD（Detune 2）

`TD*` 为 `DT*` 的同类命令（仅名称从 `DT*` 变为 `TD*`），其余参数与相关命令（`TDD/TDS/TDL/TDON/TDOF` 等）用法相同。可与 `DT*` 同时使用，但会产生较多冗余命令，建议配合 `-z` 最适化。

###### VM（Volume）

| 指令 | 说明 |
|------|------|
| `VM%1,%2,%3` | 音量变化（波形内存；按最后一次使用的音量命令决定是 v 相对还是 @v 相对） |
| `VMD<步>` | 延迟（-255~32767，默认 0；负值规则见下文） |
| `VMS<值>` | 音量倍率（0 等同 1；值过大可能溢出；默认 0） |
| `VML<步>` | 修改 1 要素步数/音符数（保持状态；当前计数结束后生效） |
| `VMON` | 再开（恢复） |
| `VMOF` | 停止 |

###### MV（Volume 2）

`MV*` 为 `VM*` 的同类命令（仅名称从 `VM*` 变为 `MV*`），其余参数与相关命令用法相同。可与 `VM*` 同时使用，但会产生较多冗余命令，建议配合 `-z` 最适化。

###### KM（PMS/AMS）

| 指令 | 说明 |
|------|------|
| `KM%1,%2,%3` | 同时变化 PMS/AMS（写入 OPM 寄存器 $38~$3F；需先通过 `MH` 设置 PMD/AMD，否则意义不大） |
| `KMD<步>` | 延迟（-255~32767，默认 0；负值规则见下文） |
| `KML<步>` | 修改 1 要素步数/音符数（保持状态；当前计数结束后生效） |
| `KMON` | 再开（恢复） |
| `KMOF` | 停止 |

###### TL（Total Level）

| 指令 | 说明 |
|------|------|
| `TL%1,%2,%3` | 改变运算器 TL（波形内存；限制较多） |
| `TLD<步>` | 延迟（-255~32767，默认 0；负值规则见下文） |
| `TLM<mask>` | 运算器掩码（0~15；bit0~3 对应 OP1~4；`-1` 自动选调制器，需在此前定义音色） |
| `TLT<音色号>` | 为 TL “伪设置”音色号（不实际切换音色；用于不切换音色改变 TL 效果；需在此前定义音色） |
| `TLL<步>` | 修改 1 要素步数/音符数（保持状态；当前计数结束后生效） |
| `TLON` | 再开（恢复） |
| `TLOF` | 停止 |

**补充（note.doc）：**
- TL 效果依赖已定义且已实际使用过的音色数据；音色设置后需要至少一次 key-on 才能保证按预期工作。
- 若将 Carrier 作为变化对象，因其按音色 TL 相对变化，`v/@v` 的变化不会被考虑；通常建议主要作用于 Modulator。

###### YA（y 写入，波形内存）

| 指令 | 说明 |
|------|------|
| `YA%1,%2,%3` | 以波形数据写入 `y` 命令：高字节=寄存器号，低字节=数据 |
| `YAD<步>` | 延迟（-255~32767，默认 0；负值规则见下文） |
| `YAL<步>` | 修改 1 要素步数/音符数（保持状态；当前计数结束后生效） |
| `YAON` | 再开（恢复） |
| `YAOF` | 停止 |

###### 其他

| 指令 | 说明 |
|------|------|
| `$FO<数值>` | 全通道淡出（数值越小淡出越快） |
| `zc<0~2>` | 在 MML 行内控制 `#cont` 的值 |
| `zw<0~2>` | 在 MML 行内控制 `#wcmd` 的值 |

**延迟为负时（note.doc）：**
- 仅在同步模式（%3=1）有效；其他模式视为 0。
- 起点以 key-off 为基准：开始位置 = key-off 时刻位置 + 延迟值；若开始位置 < 0，则等同延迟 0。
- 默认波形效果把 `&` 连接的音符视为一个音符处理；配合 `#cont 1/2` 可让连接音符分别计算相位与延迟。

##### 宏定义（Macro）

**定义格式：**
```
<宏名>[索引] = "内容"
```

**规则（note.doc）：**
- 宏名可用字符：`I J K L M N O X Y Z`、`a~z`、以及除 `｡ ｰ ﾞ ﾟ ｢ ｣ ･ ､` 外的半角片假名（共 91 个）。
- 索引范围：0~19，可定义 `91 x (20 + 1) = 1911` 个宏。
- 宏内可继续调用宏，最大嵌套 8 层；宏内容长度不限制；未定义宏默认内容为空。

**调用：**
- 一般使用 `$<宏名>` 展开宏。
- 例外：`I J N O X Z h i j m s u` 以及除 `｡ ｰ ﾞ ﾟ ｢ ｣ ･ ､` 外的半角片假名宏，可省略前导 `$` 也会被识别为宏。

---

#### 音符编写

##### 格式

```
nal
```

- `n` = 音符名称
- `a` = 升降号
- `l` = 时值

##### 音符与休止符

| 指令 | 说明 |
|------|------|
| `c d e f g a b` | 音符 |
| `r` | 休止符 |
| `+` | 升高半音 |
| `-` | 降低半音 |

##### 时值

| 指令 | 说明 |
|------|------|
| `1 2 4 8 12 16 24 32` | x 分音符 |
| `.` | 付点（延长时值的一半）|
| `%#` | 直接使用 Ticks 单位（例：`c%48` 等价于 `c4`）|

**补充（note.doc）：**
- 音长有两种表记：`%<步数>` 或 `<音长>`（用全音符为 1，表示“分母”）。
- 1 步 = 四分音符的 1/48；全音符=192 步，四分音符=48 步。
- 三连音常用“音长 × 3”表示，例如八分三连音：`a24 a24 a24`。
- `<音长>` 仅能使用能整除 192 的数值。
- `^` 叠加、`~` 扣减可用于两种音长表记，且可混用；结果需最终落在 `%1~%256`（连符除外）。

##### 音程号表记的音长写法补充（`n<音程号>`）

- `n<音程号>,<音长>` 中，当 `<音长>` 为 `%` 表记或以数字开头时，可用 `.` 代替 `,`：
  - `n0.4` 与 `n0.%48` 都表示 48 步（在 `l4` 时）。
- 当 `n<音程号>.` 的 `.` 后紧接 `^` 或不满足上述条件时，`.` 会被视为音长的一部分（例如附点）。

##### 特殊音符指令

| 指令 | 范围 | 说明 |
|------|------|------|
| `n#` | -24~119 | 音程号表记（`note.doc`：-24(o-2d+)～119(o10d)；实际发音需落在 o0d+～o8d）|
| `&` | - | 延音线（Tie，连接前后音符/休止；仅能写在音符/休止后，前后关系正确时也可写在行首）|
| `_[o,<,>]<音程>[音长]` | - | ポルタメント（按音程滑音；写在音符后；波形效果会被中断）|
| `_D#` | -6144~6144 | ポルタメント（按 detune 滑音，单位半音 1/64；写在音符后；波形效果会被中断）|
| `{ }[len]` | - | 连符（按音符数量等分时值，最多 32 个；{} 内不可用循环/波形/GL/ポルタメント后时值等）|
| `「...」[len]` / `` `...`[len] `` | - | 和弦输入（将「」内的音符/休止按通道分配；`<`/`>` 也可在「」内使用）|
| `#[len]` | - | 复用上一次和弦输入内容 |

**示例：**
```
c4&c4        ; 等同于 c2
c4&>c4       ; 跨八度绑定
c4_f         ; 音符 c 以四分音符速度滑向 f
{ceg}4       ; 三连音
```

##### 通道别指定（`|...|`）

通道别指定仅在“同一行写了多个通道识别符”时生效，用 `|...:...|` 将内容按通道分配：

```
ABC | D0p3v15c : D-4p1v13c : D4p2v12c |
```

展开后等价于：
- A：`D0p3v15c`
- B：`D-4p1v13c`
- C：`D4p2v12c`

**注意（note.doc）：**
- 分配顺序按通道本身的顺序（A→B→C…），而不是按你书写识别符的顺序。
- `:` 段数多于通道数时，超出部分会被忽略。
- `:` 段数少于通道数时，只会分配到后面的部分通道，例如：
  - `BCD |:o4c:|` → 仅 C 得到 `o4c`

##### 和弦输入（`「」` / `` ` ` `` / `#`）

和弦输入会把 `「」`（或反引号）中的音符/休止按通道逐个分配：

```
ABC 「ceg」8
; 或：ABC `ceg`8    （` 通常是 [SHIFT]+[@]）
```

展开后等价于：
- A：`c8`
- B：`e8`
- C：`g8`

**补充（note.doc）：**
- `「」` 内除音符/休止外，还能识别 `<` `>`，可输入跨八度的和弦；但只记住“和弦构成”，八度本身需在外部指定。
- 当 `「」` 内容少于通道数时，默认后续通道不展开（`#ncoder`）；可用 `#coder` 自动以休止补齐。
- 当 `「」` 内容多于通道数时，超出部分会被忽略。
- `#[len]`：复用上一次和弦输入；若此前未使用过和弦，则为空。

##### ポルタメント（滑音）补充

`note.doc` 对ポルタメント（`_` / `_D`）还有以下规则说明：

- 若ポルタメント目标音程超出可处理范围，则不会执行ポルタメント，直接保持原音。
- 若ポルタメント后继续指定音长，转换时会拆分为 `&` 连接的两段音符，例如：

```
o0d+8_o8d4
; 等价于：
o0d+8 & o8d8
```

---

##### 音符属性

| 指令 | 范围 | 说明 |
|------|------|------|
| `q#` | 1~8 | 设置断音长度（默认 q8）|
| `@q#` | 0~192 | 以 Ticks 为单位设置断音长度 |
| `Q#` | -256~256 | 波形专用量化（仅波形中有效）|
| `k#` | 0~255 | 延迟音符 # 个 Ticks |
| `w#` | 0~31 | 设置 OPM 噪声频率（省略数值则停止噪声）|

**Q# 参数说明：**
- 0：恢复由 q/@q 控制
- 1~256：以全音长的 1/256 为单位量化
- -256~-1：绝对值为实际发音步数

**补充（note.doc）：**
- `q` 与 `@q` 同时指定时，以后指定的设置为准；`@q0` 等同 `q8`。

---

##### 寄存器操作与同步

| 指令 | 说明 |
|------|------|
| `y#1,#2` | 向 OPM 寄存器写入数值（支持十进制、`$` 十六进制、`%` 二进制；如 `%11_000_101`） |
| `W` | 等待同步（停止播放直到收到同步指令）|
| `S#` | 发送同步（继续播放指定通道，A~H 或 P~W / 0~15）|
| `K` | 残响切断（OPM 通道立即切断残响）|

---

#### LFO 相关指令

##### OPM 硬件 LFO（MH）

| 指令 | 参数 | 说明 |
|------|------|------|
| `MH%1,%2,%3,%4,%5,%6,%7` | 详见下方 | 设置 OPM 硬件 LFO（该命令本身也等同 `MHON`） |
| `MHOF` | - | 停止 OPM 硬件 LFO |
| `MHON` | - | 恢复 OPM 硬件 LFO |
| `MHR` | - | 强制重置 LFO 相位 |

**MH 参数说明（note.doc）：**
- `%1`：波形（0=锯齿，1=方波，2=三角，3=采样保持/随机）
- `%2`：LFO 频率（0~255）
- `%3`：PMD（音程最大振幅，0~127）
- `%4`：AMD（音量最大振幅，0~127）
- `%5`：PMS（0~7）
- `%6`：AMS（0~3）
- `%7`：key sync（0=不同步，1=每次 key-on 同步复位）

---

##### 软件音高 LFO（MP）

| 指令 | 参数 | 说明 |
|------|------|------|
| `MP%1,%2,%3` | 详见下方 | 设置软件音高 LFO（该命令本身也等同 `MPON`） |
| `MPOF` | - | 停止软件音高 LFO |
| `MPON` | - | 恢复软件音高 LFO |

**MP 参数说明（note.doc）：**
- `%1`：波形（0=锯齿，1=方波，2=三角，3=随机）；当波形号 +4 时，音程振幅变为 256 倍
- `%2`：LFO 1/4 周期的步数
- `%3`：最大振幅（单位=半音 1/64，即 `D1`）

---

##### 软件音量 LFO（MA）

| 指令 | 参数 | 说明 |
|------|------|------|
| `MA%1,%2,%3` | 详见下方 | 设置软件音量 LFO（该命令本身也等同 `MAON`） |
| `MAOF` | - | 停止软件音量 LFO |
| `MAON` | - | 恢复软件音量 LFO |

**MA 参数说明（note.doc）：**
- `%1`：波形（0=锯齿，1=方波，2=三角，3=随机）
- `%2`：LFO 1/4 周期的步数
- `%3`：最大振幅（单位=`@v1`）

---

##### LFO 延迟（MD）

| 指令 | 范围 | 说明 |
|------|------|------|
| `MD#` | 0~255 | 软件 LFO 延迟（从 key-on 起延迟指定步数后开始；`0` 表示 key-on 与 LFO 开始不同步）|

#### NOTE.DOC 附记（原文要点）

- 转换器可能仍存在未完全排查的 bug，若出现异常，建议附上当时使用的 MML 以便定位问题。
- 程序按“希望能正常工作”的前提提供；使用风险自负，作者不承担任何事故责任。
- 转载/改造不受限制，但建议随附此文档；若对程序做了改造，建议在文档中补充说明改造内容。
- 作者署名：DIS（Rabbit #16）

**使用工具/环境（note.doc 列表）：**
- has.x（X68k High-speed Assembler v3.09）
- hlk.x（X68k SILK Hi-Speed Linker v3.01）
- hiocs.x（version 1.10+16）
- em.x（MicroEMACS PRO-68K）
- Telecom Miki Next Σ v1.4.4（をたく版 +27）
- BSIO v0.21
- TwentyOne.x Ver 1.36c
- Console driver Type-D v1.09c
- X68000 SxSI Device driver & SCSI-IOCS
- Symbolic link driver for Human68k v1.26
- execd v0.35
- X68k DCACHE v2.12
- File Selecter FSX v2.44
- maxim.x v2.21
- X68k Debugger v3.00

---

## 其他

本文档基于 MXDRV 手册整理编写。

---

## 参考资料

- [合成器基础：ADSR包络线 - 知乎](https://zhuanlan.zhihu.com/p/81771109)
- MXDRV 文档
- X68000 技术参考手册

---

**文档版本：** 0.6  
**最后更新：** 2025/9/24  
**编写者：** Ripo_2006
